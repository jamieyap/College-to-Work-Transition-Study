---
title: "Analysis: Part 1 (RAPI)"
author: 
date: '`r format(Sys.Date(), "%B %d, %Y")`'
geometry: margin=1in
output: 
  pdf_document:
  number_sections: TRUE
---
  
  
  ```{r global_options, include=FALSE}
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(rmarkdown)
library(knitr)
library(kableExtra)
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(dplyr)
library(geeM)
path_output_data <- Sys.getenv("path_output_data")

# Read in functions for data analysis
source("analysis-utils.R")

# Read in data
dat_baseline_analysis <- read.csv(file.path(path_output_data, "dat_baseline_analysis.csv"), header = TRUE)
dat_screener_analysis <- read.csv(file.path(path_output_data, "dat_screener_analysis.csv"), header = TRUE)
dat_wnw_analysis <- read.csv(file.path(path_output_data, "dat_wnw_analysis.csv"), header = TRUE)

# Center and scale variables
dat_baseline_analysis <- dat_baseline_analysis %>% mutate(across(!c("ParticipantID"), scale))
dat_screener_analysis <- dat_screener_analysis %>% mutate(across(!c("ParticipantID","sex","race"), scale))
dat_wnw_analysis_0 <- dat_wnw_analysis %>% filter(time==0) %>% mutate(across(!c("ParticipantID","time","survey_timepoint","CASEID","HED","rutgers"), scale))
dat_wnw_analysis_1 <- dat_wnw_analysis %>% filter(time==1) %>% mutate(across(!c("ParticipantID","time","survey_timepoint","CASEID","HED","rutgers"), scale))
dat_wnw_analysis <- rbind(dat_wnw_analysis_0, dat_wnw_analysis_1)
dat_wnw_analysis <- dat_wnw_analysis %>% arrange(ParticipantID, time)
remove(dat_wnw_analysis_0, dat_wnw_analysis_1)

# Merge datasets into one data frame
dat_analysis <- left_join(x = dat_wnw_analysis, y = dat_screener_analysis, by = "ParticipantID")
dat_analysis <- left_join(x = dat_analysis, y = dat_baseline_analysis, by = "ParticipantID")
dat_analysis <- dat_analysis %>% select(colnames(dat_screener_analysis), colnames(dat_baseline_analysis), everything())
```

# Hypotheses

(H1a): More permissive peer drinking norms are associated with an increase in alcohol misuse among young adults transitioning from college to work _(see Model 1a and Model 1b)_

(H1b): Role overload is associated with an increase in alcohol misuse among young adults transitioning from college to work _(see Model 1a and Model 1b)_

(H4) The effect of drinking norms on alcohol misuse intensifies over time: It is stronger during the late onboarding phase than the early onboarding phase _(see Model 2a and Model 2b)_

(H5): During the early onboarding phase, the effect of peer drinking norms on employee alcohol misuse is moderated by psychological distress such that its effect on alcohol misuse is attenuated as a function of psychological distress _(see Model 8a and Model 8b)_


# Drinking Norms Variables

Each model will be estimated with either _perceived injunctive norms_ or _perceived descriptive norms_, described below.

* Perceived injunctive work place drinking norms: mean of survey items wnw111 and wnw114

* Perceived descriptive work place drinking norms: mean of survey items wnw116 and wnw117

| wnw111 | wnw114 | wnw116 | wnw117 |
  |:-------------:|:-------------:|:-------------:|:-------------:|
  | Please indicate the degree to which these others, not you, disapprove/approve of the various patterns of alcohol consumption described. What is the extent you believe: Your closest friends at work would approve/disapprove were you to have 1-2 servings of alcohol within an hour of coming to work?  | Please indicate the degree to which these others, not you, disapprove/approve of the various patterns of alcohol consumption described. What is the extent you believe: Your closest friends and colleagues at work would approve/disapprove were you to have 1-2 servings of alcohol at work? | In the past month, how many of your closest friends and colleagues at work: Consumed 1-2 servings of alcohol within an hour before starting work? | In the past month, how many of your closest friends and colleagues at work: Consumed at least one serving of alcohol during the work day? | 
  | **1: Disapprove very much; 5: Approve very much **| **1: Disapprove very much; 5: Approve very much** | **1: None; 5: All** | **1: None; 5: All** |
  | _Higher values indicate more permissive drinking norms_ | _Higher values indicate more permissive drinking norms_ | _Higher values indicate more permissive drinking norms_ |  _Higher values indicate more permissive drinking norms_ |  


\newpage



# Model 1a

```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_1 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + injunctive_workplace_norms + qualitative_role_overload + quantitative_role_overload, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_1 <- FormatGEEOutput(fit_rutgers_1)
N_rutgers_1 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_1$dropped))
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_2 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + descriptive_workplace_norms + qualitative_role_overload + quantitative_role_overload, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_2 <- FormatGEEOutput(fit_rutgers_2)
N_rutgers_2 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_2$dropped))
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
outfit_rutgers_1 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  select(parameter, everything()) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_1, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  

outfit_rutgers_2 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  select(parameter, everything()) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_2, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  
```


# Model 2a

```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_3 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + injunctive_workplace_norms + qualitative_role_overload + quantitative_role_overload
                                + time
                                + time:injunctive_workplace_norms + time:qualitative_role_overload + time:quantitative_role_overload, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_3 <- FormatGEEOutput(fit_rutgers_3)
N_rutgers_3 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_3$dropped))
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_4 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + descriptive_workplace_norms + qualitative_role_overload + quantitative_role_overload
                                + time
                                + time:descriptive_workplace_norms + time:qualitative_role_overload + time:quantitative_role_overload, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_4 <- FormatGEEOutput(fit_rutgers_4)
N_rutgers_4 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_4$dropped))
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
outfit_rutgers_3 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  select(parameter, everything()) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_3, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  

outfit_rutgers_4 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  select(parameter, everything()) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_4, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  
```

# Model 8a

```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_5 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + injunctive_workplace_norms + qualitative_role_overload + quantitative_role_overload
                                + DASS + injunctive_workplace_norms:DASS
                                + time
                                + time:injunctive_workplace_norms 
                                + time:DASS
                                + time:injunctive_workplace_norms:DASS, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_5 <- FormatGEEOutput(fit_rutgers_5)
N_rutgers_5 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_5$dropped))
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
fit_rutgers_6 <- geem(rutgers ~ sex + race + age 
                                + baseline_rutgers + baseline_social_desirability + baseline_impulsivity + lifestress
                                + descriptive_workplace_norms + qualitative_role_overload + quantitative_role_overload
                                + DASS + descriptive_workplace_norms:DASS
                                + time
                                + time:descriptive_workplace_norms 
                                + time:DASS
                                + time:descriptive_workplace_norms:DASS, 
                  data = dat_analysis, id = ParticipantID, waves = time, corstr = "exchangeable", family = "quasipoisson")

outfit_rutgers_6 <- FormatGEEOutput(fit_rutgers_6)
N_rutgers_6 <- length(setdiff(unique(dat_analysis$ParticipantID), fit_rutgers_6$dropped))
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
outfit_rutgers_5 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  select(parameter, everything()) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_5, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  

outfit_rutgers_6 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  select(parameter, everything()) %>%
  mutate(parameter = gsub("_"," ", .data[["parameter"]])) %>%
  mutate(parameter = gsub(":"," x ", .data[["parameter"]])) %>%
  mutate_all(linebreak) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c'),
        col.names = linebreak(c("Parameter","Estimates","SE","p-value"), align = "c"),
        caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_6, sep=""), escape = FALSE) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position"))  
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Calculate effects at early onboarding phase
Lmat_low <- as.matrix(c(0,0,0,0, # intercept, sex, race, age
                        0,0,0,0, # end with lifestress
                        # END: control variables
                        1,0,0,-1,
                        0,-1,
                        0,0,0
                        ))

Lmat_mod <- as.matrix(c(0,0,0,0, # intercept, sex, race, age
                        0,0,0,0, # end with lifestress
                        # END: control variables
                        1,0,0,0,
                        0,0,
                        0,0,0
                        ))

Lmat_hig <-  as.matrix(c(0,0,0,0, # intercept, sex, race, age
                        0,0,0,0, # end with lifestress
                        # END: control variables
                        1,0,0,+1,
                        0,+1,
                        0,0,0
                        ))

Lmat_low <- t(Lmat_low)
Lmat_mod <- t(Lmat_mod)
Lmat_hig <- t(Lmat_hig)

ss_low_5 <- GetSS(use_this_model = fit_rutgers_5, L = Lmat_low)
ss_mod_5 <- GetSS(use_this_model = fit_rutgers_5, L = Lmat_mod)
ss_hig_5 <- GetSS(use_this_model = fit_rutgers_5, L = Lmat_hig)

ss_tab_5 <- rbind(ss_low_5, ss_mod_5, ss_hig_5)
row.names(ss_tab_5) <- c("At early onboarding phase: effect of norms at low DASS",
                         "At early onboarding phase: effect of norms at moderate DASS",
                         "At early onboarding phase: effect of norms at high DASS")


ss_low_6 <- GetSS(use_this_model = fit_rutgers_6, L = Lmat_low)
ss_mod_6 <- GetSS(use_this_model = fit_rutgers_6, L = Lmat_mod)
ss_hig_6 <- GetSS(use_this_model = fit_rutgers_6, L = Lmat_hig)

ss_tab_6 <- rbind(ss_low_6, ss_mod_6, ss_hig_6)
row.names(ss_tab_6) <- c("At early onboarding phase: effect of norms at low DASS",
                         "At early onboarding phase: effect of norms at moderate DASS",
                         "At early onboarding phase: effect of norms at high DASS")


ss_tab_5 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  select(parameter, everything()) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c','c','c','c'), caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_5, "; Norms Covariate: Injunctive", sep="")) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position", "scale_down"))  


ss_tab_6 %>%
  mutate(parameter = as.character(row.names(.))) %>%
  select(parameter, everything()) %>%
  kable(booktabs = TRUE, align = c('c','c','c','c','c','c','c'), caption = paste("Outcome: Rutgers Alcohol Problem Index; N = ", N_rutgers_6, "; Norms Covariate: Descriptive",  sep="")) %>%
  kable_styling(full_width = FALSE, latex_options = c("HOLD_position", "scale_down"))  
```


\newpage



